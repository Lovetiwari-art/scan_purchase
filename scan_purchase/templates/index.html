<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scan Purchase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Html5-QRCode library -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    .table-responsive { overflow-x: auto; }
    #qr-reader { width: 300px; margin: 20px auto; }
  </style>
</head>
<body class="p-3">
  <div class="container">
    <h3 class="mb-3">ðŸ“¦ Scan Purchase GRN</h3>

    <!-- Supplier & Header -->
    <div class="card p-3 mb-3">
      <div class="mb-2">
        <label>GST Number:</label>
        <div class="input-group">
          <input type="text" id="gstNumber" class="form-control" />
          <button id="btnGetSupplier" class="btn btn-primary">Get Supplier</button>
        </div>
      </div>

      <div id="supplierInfo" class="mt-2 small"></div>

      <div class="row g-2 mt-2">
        <div class="col-12 col-md-4">
          <label>Store Code:</label>
          <select id="storeCode" class="form-select">
            <option value="">-- Select Store --</option>
            <option value="ABC01">ABC01</option>
            <option value="ABC02">ABC02</option>
            <option value="ABC03">ABC03</option>
            <option value="ABC04">ABC04</option>
            <option value="ABC05">ABC05</option>
            <option value="ABC06">ABC06</option>
            <option value="ABC07">ABC07</option>
            <option value="ABC08">ABC08</option>
            <option value="ABC09">ABC09</option>
            <option value="GMFB1">GMFB1</option>
            <option value="GMFB3">GMFB3</option>
            <option value="GMFB15">GMFB15</option>
            <option value="GMWH">GMWH</option>
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label>GRN Number:</label>
          <input type="text" id="grnNumber" class="form-control" />
        </div>
        <div class="col-12 col-md-4">
          <label>GRN Date:</label>
          <input type="date" id="grnDate" class="form-control" />
        </div>
        <div class="col-12 col-md-4">
          <label>Order Number:</label>
          <input type="text" id="orderNumber" class="form-control" />
        </div>
        <div class="col-12 col-md-4">
          <label>Order Date:</label>
          <input type="date" id="orderDate" class="form-control" />
        </div>
      </div>
    </div>

    <!-- Item scan -->
    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-12 col-md-4">
          <label>EAN Code:</label>
          <div class="input-group">
            <input type="text" id="eanCode" class="form-control" placeholder="Scan or Enter EAN" />
            <button id="btnScanBarcode" class="btn btn-secondary">ðŸ“· Scan</button>
          </div>
        </div>

        <div class="col-8 col-md-4">
          <label>Item Code:</label>
          <input type="text" id="itemCode" class="form-control" />
        </div>

        <div class="col-4 col-md-2 d-grid">
          <label class="invisible">.</label>
          <button id="btnGetItem" class="btn btn-success">Get Item</button>
        </div>

        <div class="col-12 col-md-6">
          <label>Item Name:</label>
          <input type="text" id="itemName" class="form-control" readonly />
        </div>

        <div class="col-6 col-md-2">
          <label>Qty:</label>
          <input type="number" id="qty" class="form-control" />
        </div>
        <div class="col-6 col-md-2">
          <label>FQty:</label>
          <input type="number" id="fqty" class="form-control" step="0.01" />
        </div>
        <div class="col-6 col-md-2">
          <label>Rate:</label>
          <input type="number" id="rate" class="form-control" step="0.0001" />
        </div>
        <div class="col-6 col-md-2">
          <label>Disc:</label>
          <input type="number" id="disc" class="form-control" step="0.01" />
        </div>
        <div class="col-6 col-md-2">
          <label>MRP:</label>
          <input type="number" id="mrp" class="form-control" step="0.0001" />
        </div>
        <div class="col-6 col-md-2">
          <label>Sale Rate:</label>
          <input type="number" id="saleRate" class="form-control" step="0.0001" />
        </div>
        <div class="col-6 col-md-2">
          <label>Lot No:</label>
          <input type="text" id="lotNo" class="form-control" />
        </div>

        <div class="col-12 col-md-2 d-grid">
          <label class="invisible">.</label>
          <button id="btnAddItem" class="btn btn-primary">Add to Grid</button>
        </div>
      </div>
      <!-- Barcode scanner placeholder -->
      <div id="qr-reader" style="display: none;"></div>
    </div>

    <!-- Items Grid -->
    <div class="table-responsive mb-3">
      <table class="table table-bordered table-striped" id="itemsTable">
        <thead class="table-dark">
          <tr>
            <th>Item Code</th>
            <th>EAN Code</th>
            <th>Item Name</th>
            <th>Qty</th>
            <th>FQty</th>
            <th>Rate</th>
            <th>Disc</th>
            <th>MRP</th>
            <th>Sale Rate</th>
            <th>Lot No</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Submit -->
    <button id="btnSubmitGRN" class="btn btn-success w-100">Submit GRN</button>
  </div>

  <script>
  let supplier = null;
  let items = [];
  let html5QrCode = null;

  $('#btnGetSupplier').click(() => {
    $.post('/get_supplier', { gst_number: $('#gstNumber').val() }, (res) => {
      if (res.data) {
        supplier = res.data;
        $('#supplierInfo').html(
          `<b>Supplier Code:</b> ${supplier.SupplierCode}<br>
           <b>Supplier Name:</b> ${supplier.SupplierName}<br>
           <b>Address 1:</b> ${supplier.SupplierAddress1}<br>
           <b>Address 2:</b> ${supplier.SupplierAddress2}`
        );
      } else {
        alert('No supplier found.');
      }
    });
  });

  $('#btnGetItem').click(() => {
    const code = $('#eanCode').val() || $('#itemCode').val();
    const isEAN = !!$('#eanCode').val();
    $.post('/get_item', {
      code: code,
      store_code: $('#storeCode').val(),
      is_ean: isEAN,
    }, (res) => {
      if (res.data) {
        $('#itemCode').val(res.data.ItemCode);
	$('#eanCode').val(res.data.EANCode); // âœ… Add this line to set EAN!
	$('#itemName').val(res.data.ItemName);
        $('#itemName').val(res.data.ItemName);
        $('#rate').val(res.data.PurRate);
        $('#mrp').val(res.data.MRP);
        $('#saleRate').val(res.data.SalePrice);
        $('#lotNo').val(res.data.LotNo);
      } else {
        alert('Item not found.');
      }
    });
  });



  $('#btnAddItem').click(() => {
    const qty = $('#qty').val();
    if (!qty || parseFloat(qty) <= 0) {
      alert('Please enter Qty.');
      $('#qty').focus();
      return;
    }

    const newItem = {
      ItemCode: $('#itemCode').val(),
      EANCode: $('#eanCode').val(),
      ItemName: $('#itemName').val(),
      Qty: qty,
      FQty: $('#fqty').val(),
      Rate: $('#rate').val(),
      Disc: $('#disc').val(),
      MRP: $('#mrp').val(),
      SaleRate: $('#saleRate').val(),
      LotNumber: $('#lotNo').val(),
    };

    items.push(newItem);

    $('#itemsTable tbody').append(
      `<tr>
        <td>${newItem.ItemCode}</td>
        <td>${newItem.EANCode}</td>
        <td>${newItem.ItemName}</td>
        <td>${newItem.Qty}</td>
        <td>${newItem.FQty}</td>
        <td>${newItem.Rate}</td>
        <td>${newItem.Disc}</td>
        <td>${newItem.MRP}</td>
        <td>${newItem.SaleRate}</td>
        <td>${newItem.LotNumber}</td>
        <td><button class="btn btn-danger btn-sm btn-delete">Delete</button></td>
      </tr>`
    );

    $('#itemCode, #eanCode, #itemName, #qty, #fqty, #rate, #disc, #mrp, #saleRate, #lotNo').val('');
    $('#eanCode').focus();
  });

  $('#itemsTable').on('click', '.btn-delete', function () {
    const index = $(this).closest('tr').index();
    items.splice(index, 1);
    $(this).closest('tr').remove();
  });

  $('#btnSubmitGRN').click(() => {
    if (!supplier) {
      alert('Please fetch supplier first.');
      return;
    }
    if (items.length === 0) {
      alert('Please add at least one item.');
      return;
    }

    const payload = {
      StoreCode: $('#storeCode').val(),
      GRNNumber: $('#grnNumber').val(),
      GRNDate: $('#grnDate').val(),
      OrderNumber: $('#orderNumber').val(),
      OrderDate: $('#orderDate').val(),
      GSTNumber: $('#gstNumber').val(),
      SupplierCode: supplier.SupplierCode,
      SupplierName: supplier.SupplierName,
      SupplierAddress1: supplier.SupplierAddress1,
      SupplierAddress2: supplier.SupplierAddress2,
      Items: items,
    };

    $.ajax({
      url: '/submit_grn',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(payload),
      success: (res) => {
        alert(res.message);
        window.location.reload();
      },
    });
  });

  $('#btnScanBarcode').click(() => {
    $('#qr-reader').show();
    $('#qr-reader').after('<button id="btnStopScan" class="btn btn-danger mt-2">Stop Scan</button>');

    html5QrCode = new Html5Qrcode("qr-reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          decodedText => {
            $('#eanCode').val(decodedText);
            html5QrCode.stop().then(() => {
              $('#qr-reader').hide();
              $('#btnStopScan').remove();
            });
          },
          error => {
            // ignore errors
          }
        ).catch(err => {
          alert("Camera start failed: " + err);
        });
      } else {
        alert("No camera found.");
      }
    }).catch(err => {
      alert("Camera init error: " + err);
    });
  });

  $(document).on('click', '#btnStopScan', () => {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        $('#qr-reader').hide();
        $('#btnStopScan').remove();
      }).catch(err => {
        alert("Stop failed: " + err);
      });
    }
  });
  </script>
</body>
</html>
