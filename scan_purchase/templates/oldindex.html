<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scan Purchase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  />
  <style>
    /* Make table scrollable on small screens */
    .table-responsive {
      overflow-x: auto;
    }
  </style>
</head>
<body class="p-3">
  <div class="container">
    <h3 class="mb-3">ðŸ“¦ Scan Purchase GRN</h3>

    <!-- Supplier & Header -->
    <div class="card p-3 mb-3">
      <div class="mb-2">
        <label>GST Number:</label>
        <div class="input-group">
          <input type="text" id="gstNumber" class="form-control" />
          <button id="btnGetSupplier" class="btn btn-primary">Get Supplier</button>
        </div>
      </div>

      <div id="supplierInfo" class="mt-2 small"></div>

      <div class="row g-2 mt-2">
        <div class="col-12 col-md-4">
          <label>Store Code:</label>
          <input type="text" id="storeCode" class="form-control" />
        </div>
        <div class="col-12 col-md-4">
          <label>GRN Number:</label>
          <input type="text" id="grnNumber" class="form-control" />
        </div>
        <div class="col-12 col-md-4">
          <label>GRN Date:</label>
          <input type="date" id="grnDate" class="form-control" />
        </div>
        <div class="col-12 col-md-4">
          <label>Order Number:</label>
          <input type="text" id="orderNumber" class="form-control" />
        </div>
        <div class="col-12 col-md-4">
          <label>Order Date:</label>
          <input type="date" id="orderDate" class="form-control" />
        </div>
      </div>
    </div>

   http://103.197.122.4:5050/

    <!-- Items Grid -->
    <div class="table-responsive mb-3">
      <table class="table table-bordered table-striped" id="itemsTable">
        <thead class="table-dark">
          <tr>
            <th>Item Code</th>
            <th>EAN Code</th>
            <th>Item Name</th>
            <th>Qty</th>
            <th>FQty</th>
            <th>Rate</th>
            <th>Disc</th>
            <th>MRP</th>
            <th>Sale Rate</th>
            <th>Lot No</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Submit -->
    <button id="btnSubmitGRN" class="btn btn-success w-100">Submit GRN</button>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    let supplier = null;
    let items = [];

    $('#btnGetSupplier').click(() => {
      $.post('/get_supplier', { gst_number: $('#gstNumber').val() }, (res) => {
        if (res.data) {
          supplier = res.data;
          $('#supplierInfo').html(
            `<b>Supplier Code:</b> ${supplier.SupplierCode}<br>
             <b>Supplier Name:</b> ${supplier.SupplierName}<br>
             <b>Address 1:</b> ${supplier.SupplierAddress1}<br>
             <b>Address 2:</b> ${supplier.SupplierAddress2}`
          );
        } else {
          alert('No supplier found.');
        }
      });
    });

    $('#btnGetItem').click(() => {
      const code = $('#eanCode').val() || $('#itemCode').val();
      const isEAN = !!$('#eanCode').val();
      $.post('/get_item', {
        code: code,
        store_code: $('#storeCode').val(),
        is_ean: isEAN,
      }, (res) => {
        if (res.data) {
          $('#itemCode').val(res.data.ItemCode);
          $('#itemName').val(res.data.ItemName);
          $('#rate').val(res.data.PurRate);
          $('#mrp').val(res.data.MRP);
          $('#saleRate').val(res.data.SalePrice);
          $('#lotNo').val(res.data.LotNo);
        } else {
          alert('Item not found.');
        }
      });
    });

    $('#btnAddItem').click(() => {
      const newItem = {
        ItemCode: $('#itemCode').val(),
        EANCode: $('#eanCode').val(),
        ItemName: $('#itemName').val(),
        Qty: $('#qty').val(),
        FQty: $('#fqty').val(),
        Rate: $('#rate').val(),
        Disc: $('#disc').val(),
        MRP: $('#mrp').val(),
        SaleRate: $('#saleRate').val(),
        LotNumber: $('#lotNo').val(),
      };

      items.push(newItem);

      $('#itemsTable tbody').append(
        `<tr>
          <td>${newItem.ItemCode}</td>
          <td>${newItem.EANCode}</td>
          <td>${newItem.ItemName}</td>
          <td>${newItem.Qty}</td>
          <td>${newItem.FQty}</td>
          <td>${newItem.Rate}</td>
          <td>${newItem.Disc}</td>
          <td>${newItem.MRP}</td>
          <td>${newItem.SaleRate}</td>
          <td>${newItem.LotNumber}</td>
          <td><button class="btn btn-danger btn-sm btn-delete">Delete</button></td>
        </tr>`
      );

      $('#itemCode, #eanCode, #itemName, #qty, #fqty, #rate, #disc, #mrp, #saleRate, #lotNo').val('');
      $('#eanCode').focus();
    });

    $('#itemsTable').on('click', '.btn-delete', function () {
      const index = $(this).closest('tr').index();
      items.splice(index, 1);
      $(this).closest('tr').remove();
    });

    $('#btnSubmitGRN').click(() => {
      if (!supplier) {
        alert('Please fetch supplier first.');
        return;
      }
      if (items.length === 0) {
        alert('Please add at least one item.');
        return;
      }

      const payload = {
        StoreCode: $('#storeCode').val(),
        GRNNumber: $('#grnNumber').val(),
        GRNDate: $('#grnDate').val(),
        OrderNumber: $('#orderNumber').val(),
        OrderDate: $('#orderDate').val(),
        GSTNumber: $('#gstNumber').val(),
        SupplierCode: supplier.SupplierCode,
        SupplierName: supplier.SupplierName,
        SupplierAddress1: supplier.SupplierAddress1,
        SupplierAddress2: supplier.SupplierAddress2,
        Items: items,
      };

      $.ajax({
        url: '/submit_grn',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: (res) => {
          alert(res.message);
          window.location.reload();
        },
      });
    });
  </script>
</body>
</html>
